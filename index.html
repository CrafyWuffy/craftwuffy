<script>
    // --- TEMEL SİSTEMLER ---
    new ClipboardJS('#copyIp').on('success', () => Swal.fire('IP Kopyalandı!', 'Sunucuya bağlanmak için Minecraft\'a yapıştır.', 'success'));

    function show(id) {
        $('.nav-link').removeClass('active');
        $(`a[onclick="show('${id}')"]`).addClass('active');
        $('#anasayfa_sec, #forum_sec, #magaza_sec, #destek_sec').hide();
        $(`#${id}_sec`).fadeIn();
        if(id === 'forum') loadPosts();
    }

    // --- MARKET SATIN ALMA SİSTEMİ ---
    function buyItem(itemName, price) {
        const user = localStorage.getItem('mc_user');
        
        if(!user) {
            Swal.fire({
                icon: 'warning',
                title: 'Giriş Yapmalısın',
                text: 'Marketten alışveriş yapmak için önce Minecraft hesabınla giriş yapmalısın.',
                confirmButtonText: 'Giriş Yap',
                showCancelButton: true,
                cancelButtonText: 'Kapat'
            }).then((result) => {
                if (result.isConfirmed) loginModal();
            });
            return;
        }

        Swal.fire({
            title: 'Satın Alma Onayı',
            html: `<b>${user}</b> adlı oyuncu için <b>${itemName}</b> alıyorsun.<br><br>Fiyat: <span class="text-success fw-bold">${price} TL</span>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#0054a6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ödeme Yap',
            cancelButtonText: 'Vazgeç'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire(
                    'İşlem Başarılı!',
                    'Ödeme sistemimiz bu akşam açılışla birlikte aktif olacaktır. Discord üzerinden dekont ileterek şimdiden alabilirsin.',
                    'success'
                );
            }
        });
    }

    // --- GİRİŞ SİSTEMİ ---
    function loginModal() {
        // ... (Senin mevcut loginModal kodun buraya gelecek)
        Swal.fire({
            title: 'Minecraft Girişi',
            text: 'Oyundaki adın ve şifrenle gir.',
            html: `
                <input type="text" id="login-user" class="swal2-input" placeholder="Kullanıcı Adı">
                <input type="password" id="login-pass" class="swal2-input" placeholder="Şifre">
            `,
            confirmButtonText: 'Giriş Yap',
            preConfirm: () => {
                const username = $('#login-user').val();
                const password = $('#login-pass').val();
                if(!username || !password) return Swal.showValidationMessage('Boş bırakma!');
                return { username, password };
            }
        }).then((res) => {
            if(res.isConfirmed) {
                // Not: Buradaki /api/login senin backend tarafına bağlıdır.
                $.ajax({
                    url: '/api/login',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(res.value),
                    success: function(data) {
                        localStorage.setItem('mc_user', data.username);
                        Swal.fire('Hoş geldin!', data.username, 'success').then(() => location.reload());
                    },
                    error: () => Swal.fire('Hata', 'Şifre veya kullanıcı adı yanlış!', 'error')
                });
            }
        });
    }

    function checkAuth() {
        const user = localStorage.getItem('mc_user');
        if(user) {
            $('#authArea').html(`
                <div class="dropdown">
                    <button class="btn btn-light rounded-pill dropdown-toggle fw-bold" data-bs-toggle="dropdown">
                        <img src="https://minotar.net/helm/${user}/32" class="user-head"> ${user}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Çıkış Yap</a></li>
                    </ul>
                </div>
            `);
            $('#forumInputArea').html(`
                <div class="bg-light p-4 rounded-4 mb-4 shadow-sm border">
                    <h5 class="fw-bold mb-3">Mesaj Yaz (Olarak: ${user})</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="f_msg" class="form-control" placeholder="Bir şeyler yaz...">
                        <button onclick="savePost()" class="btn btn-primary px-4 fw-bold">Gönder</button>
                    </div>
                </div>
            `);
        }
    }

    function logout() {
        localStorage.removeItem('mc_user');
        location.reload();
    }

    // --- FORUM SİSTEMİ ---
    function loadPosts() {
        $('#post_loading').removeClass('d-none');
        $.get('/api/forum', function(data) {
            let h = '';
            data.forEach(p => {
                h += `
                <div class="live-post shadow-sm">
                    <div class="d-flex align-items-center mb-2">
                        <img src="https://minotar.net/helm/${p.username}/32" class="user-head">
                        <div>
                            <div class="fw-bold text-primary">${p.username}</div>
                            <small class="text-muted">${new Date(p.created_at).toLocaleString()}</small>
                        </div>
                    </div>
                    <div class="ps-1">${p.content}</div>
                </div>`;
            });
            $('#dynamic_posts').html(h || '<p class="text-center">Henüz mesaj yok.</p>');
            $('#post_loading').addClass('d-none');
        });
    }

    function savePost() {
        const user = localStorage.getItem('mc_user');
        const msg = $('#f_msg').val();
        if(!msg) return;

        $.ajax({
            url: '/api/forum', type: 'POST', contentType: 'application/json',
            data: JSON.stringify({ username: user, content: msg }),
            success: function() {
                $('#f_msg').val('');
                loadPosts();
            }
        });
    }

    // --- İSTATİSTİKLER ---
    function sync() {
        $.getJSON('https://api.mcstatus.io/v2/status/java/94.154.46.130', d => {
            if(d.online) {
                let t = d.players.online + " / " + d.players.max;
                $('#side-count').text(t);
                $('#heroCount').text(d.players.online + " Aktif");
            } else {
                $('#side-count').text("KAPALI");
                $('#heroCount').text("OFFLINE");
            }
        });
        $.getJSON('https://api.lanyard.rest/v1/users/812040098388377671', r => {
            if(r.data) {
                const s = r.data.discord_status !== 'offline';
                $('#admin-dot').attr('class', 'dot ' + (s ? 'dot-online' : 'dot-offline'));
                $('#admin-status').text(s ? 'AKTİF' : 'ÇEVRİMDİŞİ');
            }
        });
    }

    $(document).ready(() => {
        checkAuth();
        sync();
        setInterval(sync, 30000);
    });
</script>
